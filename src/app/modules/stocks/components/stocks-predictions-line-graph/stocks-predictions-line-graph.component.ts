import {
  AfterViewInit,
  Component,
  Input,
} from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import * as Highcharts from 'highcharts';

import { StocksDataService } from 'src/app/core/services/stocks-data.service';

@Component({
  selector: 'app-stocks-predictions-line-graph',
  templateUrl: './stocks-predictions-line-graph.component.html',
  styleUrls: ['./stocks-predictions-line-graph.component.scss'],
})
export class StocksPredictionsLineGraphComponent implements AfterViewInit {

  private _algorithm!: string
  @Input() ticker!: string;

  get algorithm(): string {
    return this._algorithm;
  }

  @Input() set algorithm(value: string)
  {
    this._algorithm = value;
    this.updateChart()
  }

  updateFlag: boolean = false;
  public highcharts: any = Highcharts;
  public chartOptions: any = {
    title: {
      text: 'Price predictions for this algorithm',
    },
    series: [
      {
        type: 'line',
        caption: {
          align: 'left',
          floating: false,
          margin: 15,
          style: { color: '#666666' },
          useHTML: false,
          verticalAlign: 'bottom',
          x: 0,
          y: undefined,
        },
        name: 'Price',
        data: [],
      },
    ],
  };

  constructor(
    private stocksService: StocksDataService,
    private route: ActivatedRoute
  ) {
    this.ticker = this.route.snapshot.paramMap.get('ticker') || '';

    console.log(`ticker is now: ${this.ticker}`);
    console.log(`alg is now: ${this.algorithm}`);
  }
  ngAfterViewInit(): void {
    this.updateChart();
  }

  updateChart() {
    this.updateFlag = false;
    console.log('Commencing line graph update');

    this.stocksService
      .gatherCompanyForecastData(this.ticker, 0, 1000, this.algorithm)
      .subscribe((result) => {
        var observations = result.predictions.map((obs) => [
          obs.date,
          obs.price,
        ]);

        console.log(observations);

        this.chartOptions.series[0].data = observations;
        this.chartOptions.title.text = `Predictions generated by ${this.algorithm}`
        this.updateFlag = true;
      });
  }
}
